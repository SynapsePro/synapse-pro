<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Synapse Pro - Mixtral Chat</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --body-bg: #F6F6F6; --response-bg: #ffffff; --text-color: #212529;
            --border-color: #dee2e6; --input-bg: #ffffff; --placeholder-color: #6c757d;
            --button-send-bg: #0071D3; --button-send-text: #ffffff; --footer-text: #6c757d;
            --loading-gif-height: 60px; --start-gif-max-width: 100px; --followup-button-bg: #e9ecef;
            --followup-button-text: #495057; --followup-button-border: #ced4da;
            --bot-message-border-color: #0071D3; --hidden-color: #F6F6F6;
            --highlight-color-term: #005EB8; --highlight-color-concept: #28a745;
        }
        [data-theme="dark"] {
            --body-bg: #212529; --response-bg: rgb(50, 50, 50); --text-color: #f8f9fa;
            --border-color: #495057; --input-bg: rgb(50, 50, 50); --placeholder-color: #adb5bd;
            --button-send-bg: #005eb8; --button-send-text: #ffffff; --footer-text: #adb5bd;
            --followup-button-bg: rgb(50, 50, 50); --followup-button-text: #f8f9fa;
            --followup-button-border: #6c757d; --bot-message-border-color: #0071D3;
            --hidden-color: var(--body-bg); --highlight-color-term: #66bfff;
            --highlight-color-concept: #52c41a;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Poppins', sans-serif; background-color: var(--body-bg); color: var(--text-color);
            display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        #prompt-bar, #prompt-input, #go-button { display: none; } /* Hide automation bar */
        #response-output { flex-grow: 1; overflow-y: auto; padding: 25px; display: flex; flex-direction: column; }
        .message.bot-message { background-color: var(--response-bg); padding: 15px 20px; border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 20px; max-width: 100%;
            line-height: 1.6; white-space: pre-wrap; border: 1px solid var(--bot-message-border-color); }
        .message.initial-message { text-align: center; border: none; padding: 25px; }
        .error-message { background-color: #f8d7da; color: #842029; font-weight: bold; border-color: #f5c2c7; }
        [data-theme="dark"] .error-message { background-color: #842029; color: #f8d7da; border-color: #8f2b36; }
        .thinking-message { text-align: center; font-style: italic; color: var(--placeholder-color); background-color: transparent; box-shadow: none; border: none; }
        .loading-gif { display: block; height: var(--loading-gif-height); width: auto; margin: 0 auto 10px auto; }
        #api-key-area { padding: 10px 15px; background-color: var(--response-bg); text-align: center;
            border-top: 1px solid var(--border-color); display: flex; align-items: center; justify-content: center; gap: 8px; flex-shrink: 0; }
        #api-key-input { width: 300px; padding: 5px 8px; border-radius: 5px; border: 1px solid var(--border-color);
            background-color: var(--input-bg); color: var(--text-color); }
        #save-key-button { padding: 5px 12px; border-radius: 5px; border: 1px solid var(--button-send-bg);
            background-color: var(--button-send-bg); color: var(--button-send-text); cursor: pointer; }
        #key-status { font-size: 0.8em; color: var(--footer-text); min-width: 100px; text-align: left; }
        #input-area { display: flex; padding: 15px; border-top: 1px solid var(--border-color); background-color: var(--body-bg); flex-shrink: 0; }
        #user-input { flex-grow: 1; padding: 10px 15px; border-radius: 20px; margin-right: 10px; border: 1px solid var(--border-color);
            background-color: var(--input-bg); color: var(--text-color); font-size: 1em; resize: none; outline: none; }
        #send-button { padding: 10px 20px; background-color: var(--button-send-bg); color: var(--button-send-text);
            border: none; border-radius: 20px; cursor: pointer; font-size: 1em; font-weight: 600; }
        #send-button:disabled { background-color: #6c757d; cursor: not-allowed; }
        #footer-disclaimer { padding: 10px 20px; display: flex; justify-content: space-between; align-items: center;
            font-size: 0.75em; color: var(--footer-text); background-color: var(--body-bg); flex-shrink: 0;
            border-top: 1px solid var(--border-color); }
        .footer-toggle-container { display: flex; align-items: center; }
        .darkmode-label { margin-right: 5px; font-size: 0.9em; }
        .switch { position: relative; display: inline-block; width: 34px; height: 20px; vertical-align: middle; }
        .switch input { display:none; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 20px; }
        .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #0071D3; }
        input:checked + .slider:before { transform: translateX(14px); }
    </style>
</head>
<body>
    <main id="response-output">
        <div class="message bot-message initial-message">
             <h2>Welcome to Synapse Pro</h2>
             <p>Please enter your Pro Key below to begin.</p>
        </div>
    </main>
    
    <div id="api-key-area">
        <input type="password" id="api-key-input" placeholder="Enter your Synapse Pro Key...">
        <button id="save-key-button">Save Key</button>
        <span id="key-status"></span>
    </div>

    <div id="input-area">
        <input type="text" id="user-input" placeholder="Ask something...">
        <button id="send-button">Send</button>
    </div>

    <footer id="footer-disclaimer">
        <span>The Synapse Pro AI can make mistakes. Please check important Information.</span>
        <div class="footer-toggle-container">
            <span class="darkmode-label">Darkmode</span>
            <label class="switch"><input type="checkbox" id="darkmode-toggle"><span class="slider round"></span></label>
        </div>
    </footer>

    <script>
        // --- DOM Element References ---
        const responseOutput = document.getElementById('response-output');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        const darkModeToggle = document.getElementById('darkmode-toggle');
        const apiKeyInput = document.getElementById('api-key-input');
        const saveKeyButton = document.getElementById('save-key-button');
        const keyStatus = document.getElementById('key-status');

        // --- CONFIGURATION ---
        const BACKEND_API_URL = 'https://synapse-pro.vercel.app/api/chat'; // DEINE ECHTE VERCEL URL
        const MAX_HISTORY_LENGTH = 10;
        const STORAGE_KEY = 'synapseProApiKey';

        // --- Global State ---
        let chatHistory = [];
        let currentApiKey = null;

        // --- Functions ---
        function saveApiKey() {
            const key = apiKeyInput.value.trim();
            if (key) {
                localStorage.setItem(STORAGE_KEY, key);
                currentApiKey = key;
                keyStatus.textContent = "Key saved!";
                keyStatus.style.color = 'green';
                apiKeyInput.value = '';
                toggleChatInput(true); // Chat freischalten
            } else {
                localStorage.removeItem(STORAGE_KEY);
                currentApiKey = null;
                keyStatus.textContent = "Key removed.";
                keyStatus.style.color = 'orange';
                toggleChatInput(false); // Chat sperren
            }
        }

        function loadApiKey() {
            const savedKey = localStorage.getItem(STORAGE_KEY);
            if (savedKey) {
                currentApiKey = savedKey;
                keyStatus.textContent = "Pro Key active.";
                keyStatus.style.color = 'green';
                toggleChatInput(true);
            } else {
                keyStatus.textContent = "No Pro Key found.";
                keyStatus.style.color = 'gray';
                toggleChatInput(false);
            }
        }
        
        function toggleChatInput(enabled) {
            userInput.disabled = !enabled;
            sendButton.disabled = !enabled;
            userInput.placeholder = enabled ? "Ask something..." : "Please enter a Pro Key to start.";
        }

        function toggleTheme() {
             const isDark = darkModeToggle.checked;
             document.documentElement.setAttribute('data-theme', isDark ? 'dark' : 'light');
             localStorage.setItem('synapseTheme', isDark ? 'dark' : 'light');
        }

        function applySavedTheme() {
            const savedTheme = localStorage.getItem('synapseTheme');
            if (savedTheme === 'dark') {
                darkModeToggle.checked = true;
                document.documentElement.setAttribute('data-theme', 'dark');
            }
        }

        function createMessageElement(text, type = 'bot', isThinking = false, isError = false) {
             const messageDiv = document.createElement('div');
             messageDiv.classList.add('message');
             if (isThinking) {
                 messageDiv.classList.add('thinking-message');
                 const img = document.createElement('img'); img.src = 'loading.gif'; img.alt = 'Loading...'; img.classList.add('loading-gif');
                 messageDiv.appendChild(img);
                 messageDiv.appendChild(document.createTextNode('Analyzing...'));
                 messageDiv.dataset.thinkingId = `thinking-${Date.now()}`;
             } else if (isError) {
                 messageDiv.classList.add('bot-message', 'error-message');
                 messageDiv.textContent = text;
             } else if (type === 'bot') {
                 messageDiv.classList.add('bot-message');
                 messageDiv.innerHTML = text;
             }
            return messageDiv;
        }

        function scrollToBottom() { setTimeout(() => { responseOutput.scrollTop = responseOutput.scrollHeight; }, 50); }

        async function handleSend() {
            const inputText = userInput.value.trim(); if (!inputText) return;
            
            userInput.disabled = true; sendButton.disabled = true; userInput.value = '';
            const initialMessage = responseOutput.querySelector('.initial-message');
            if (initialMessage) { initialMessage.style.display = 'none'; }

            const thinkingMsgElement = createMessageElement('', 'bot', true);
            responseOutput.appendChild(thinkingMsgElement); scrollToBottom();

            try {
                const response = await fetch(BACKEND_API_URL, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        userMessage: inputText, 
                        chatHistory: chatHistory,
                        apiKey: currentApiKey 
                    })
                });
                const currentThinkingElement = responseOutput.querySelector(`[data-thinking-id="${thinkingMsgElement.dataset.thinkingId}"]`);
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ error: `Backend Error: ${response.statusText}` }));
                    throw new Error(errorData.error || response.statusText);
                }
                const data = await response.json();
                if (data.choices && data.choices[0].message) {
                    const botReply = data.choices[0].message.content;
                    const replyElement = createMessageElement(botReply, 'bot');
                    chatHistory.push({ role: "user", content: inputText });
                    chatHistory.push({ role: "assistant", content: botReply });
                    if (chatHistory.length > MAX_HISTORY_LENGTH) { chatHistory = chatHistory.slice(-MAX_HISTORY_LENGTH); }
                    if (currentThinkingElement) { currentThinkingElement.replaceWith(replyElement); }
                } else { throw new Error(data.error || 'Unexpected response structure.'); }
            } catch (error) {
                const currentThinkingElement = responseOutput.querySelector(`[data-thinking-id="${thinkingMsgElement.dataset.thinkingId}"]`);
                const errorElement = createMessageElement(error.message, 'bot', false, true);
                if (currentThinkingElement) { currentThinkingElement.replaceWith(errorElement); }
            } finally {
                if (currentApiKey) { // Nur freischalten, wenn ein Schlüssel aktiv ist
                    userInput.disabled = false; sendButton.disabled = false; userInput.focus();
                }
                scrollToBottom();
            }
        }

        // --- Initialization ---
        saveKeyButton.addEventListener('click', saveApiKey);
        sendButton.addEventListener('click', handleSend);
        userInput.addEventListener('keypress', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleSend(); } });
        darkModeToggle.addEventListener('change', toggleTheme);

        applySavedTheme();
        loadApiKey(); // Lädt den Schlüssel und passt die UI beim Start an
    </script>
</body>
</html>
